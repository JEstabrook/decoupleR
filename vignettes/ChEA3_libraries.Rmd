---
title: "ChEA3 libraries"
author: "Celina Geiss"
output: html_notebook
---

<!-- output: rmarkdown::html_vignette -->
<!-- vignette: > -->
<!--   %\VignetteIndexEntry{test} -->
<!--   %\VignetteEngine{knitr::rmarkdown} -->
<!--   %\VignetteEncoding{UTF-8} -->


```{r KnitR config, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)

# save all figures of the Rmd as png and pdf in the figures directory
figure_directory = "figures/"
if(!dir.exists(figure_directory)) dir.create(figure_directory)
knitr::opts_chunk$set(dev = c("png", "pdf"), fig.path = figure_directory)
```



# Setup packages

To run this Rmarkdown, the packages `tidyverse` and `UpSetR` are required.

```{r Setup, include = FALSE}
library(tidyverse)
library(UpSetR)
```

# Curation of the libraries

## Download all six ChEA3 libraries

See Downloads on [ChEA3 website](https://amp.pharm.mssm.edu/chea3/).

```{r Downoad libraries, include =FALSE}
archs4 <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/ARCHS4_Coexpression.gmt", delim = "\t", col_names = FALSE)
encode <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/ENCODE_ChIP-seq.gmt", delim = "\t", col_names = FALSE)
enrichr <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/Enrichr_Queries.gmt", delim = "\t", col_names = FALSE)
gtex <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/GTEx_Coexpression.gmt", delim = "\t", col_names = FALSE)
literature <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/Literature_ChIP-seq.gmt", delim = "\t", col_names = FALSE)
remap <- read_delim("https://amp.pharm.mssm.edu/chea3/assets/tflibs/ReMap_ChIP-seq.gmt", delim = "\t", col_names = FALSE)
```

In all libraries the TF column was renamed. In the *encode* and *literature* 
library human were extracted.

```{r Rename and filter}
archs4 <- archs4 %>% 
    rename(tf = X1) %>%
    separate(tf, into = c("tf"), sep="_", extra = "drop")

encode  <- encode %>% 
    filter(grepl("HG19", X1)) %>%  # extract human TFs
    rename(tf = X1) %>%
    separate(tf, into = c("tf"), sep="_", extra = "drop")

enrichr <- enrichr %>% 
    rename(tf=X1)

gtex <- gtex %>% 
    rename(tf=X1)

literature <- literature %>% 
    filter(grepl("HUMAN", X1)) %>%  # 4 human TFs are missing (should be 138)
    rename(tf = X1) %>%
    separate(tf, into = c("tf"), sep="_", extra = "drop")

remap <- remap %>% 
    rename(tf=X1)
```

## Create "tidy" interaction tables

```{r Interaction tables}
# Define function to produce paired interaction tables

interaction_table <- function(library, interaction_library, confidence) {
    interaction_library <- library %>%
        select(tf, target=X2) %>% 
        add_column(confidence=confidence)
    cols <- seq(3, ncol(library))
    for (col in cols) {
        paired_interactions <- library %>% select(tf, target = col) %>% add_column(confidence=confidence)
        interaction_library <- interaction_library %>% add_row(paired_interactions)
    }
    return(interaction_library)
}

# Apply function to build interaction tables
archs4_interactions <- interaction_table(archs4, archs4_interactions, "archs4_coexpression")
encode_interactions <- interaction_table(encode, encode_interactions, "encode_chip-seq")
enrichr_interactions <- interaction_table(enrichr, enrichr_interactions, "enrichr_queries")
gtex_interactions <- interaction_table(gtex, gtex_interactions, "gtex_coexpression")
literature_interactions <- interaction_table(literature, literature_interactions, "literature_chip-seq")
remap_interactions <- interaction_table(remap, remap_interactions, "remap_chip-seq")

libs <- list(archs4_interactions, encode_interactions, enrichr_interactions, gtex_interactions, literature_interactions, remap_interactions)

# Unite all libraries in one table
libs_combined <- map_dfr(libs, function(lib) {
  lib <- lib %>% arrange(tf, target)
})
```

```{r Alternative solution, eval = FALSE}
# Faster way from Christian
paths = c("https://amp.pharm.mssm.edu/chea3/assets/tflibs/ARCHS4_Coexpression.gmt",
          "https://amp.pharm.mssm.edu/chea3/assets/tflibs/ENCODE_ChIP-seq.gmt",
          "https://amp.pharm.mssm.edu/chea3/assets/tflibs/Enrichr_Queries.gmt",
          "https://amp.pharm.mssm.edu/chea3/assets/tflibs/GTEx_Coexpression.gmt",
          "https://amp.pharm.mssm.edu/chea3/assets/tflibs/Literature_ChIP-seq.gmt",
          "https://amp.pharm.mssm.edu/chea3/assets/tflibs/ReMap_ChIP-seq.gmt")
map(paths, function(path) {
    # load file in gmt format
    df = read_delim(path, delim = "\t", col_names = FALSE)
    # extract library name from file path
    lib = path %>%
        basename() %>%
        str_remove(".gmt") %>%
        str_to_lower() %>%
        str_replace("-", "_")
    # tidy gmt file
    tidy_df = df %>%
        rename(tf = X1) %>%
        separate(tf, into = c("tf"), sep="_", extra = "drop") %>%
        pivot_longer(-tf, names_to = "key", values_to = "target") %>%
        select(-key) %>%
        mutate(confidence = lib)
})
```


## Visualisation of TFs and interactions across the different libraries

```{r Tile plot, eval = FALSE}
# Group and summarise libraries
# Group by TFs
tf_grouped_libs <- group_by(libs_combined, tf)
summary_tf <- summarise(tf_grouped_libs, lib = unique(confidence)) %>% 
  summarise(lib, counts = n())

# Plot distributions of TFs in the different libraries
# Tile plot
ggplot(summary_tf, aes(x = reorder(tf, -counts), y = reorder(lib, -counts), fill = counts)) + 
  geom_tile() +
  xlab("TFs") +
  ylab("libraries")
```


```{r Upset plot, echo = TRUE}
# Split by confidence and name each sub-list after lib
conf_grouped_libs <- group_by(libs_combined, confidence) %>% 
  select(-target) %>%  # remove target column
  group_split(keep=FALSE)  # drop group coulumn
names(conf_grouped_libs) <- c("ARCHS4 Coexpression", "ENCODE ChIP-seq", "Enrichr Queries", "GTEx Coexpression", "Literature ChIP-seq", "ReMap ChIP-seq")

# Convert nested list into list of vectors (accepted form for upset())
upset_input <- map(conf_grouped_libs, function(lib) {
  lib %>% pull()
})

# Create upset plot
upset(fromList(upset_input), 
      nsets = 6, 
      order.by = "freq",
      mainbar.y.label = "TFs",
      sets.x.label = "Library Size"
      )
```


## Session Info

This document was processed on: `r Sys.Date()`.

```{r}
sessionInfo()
```
